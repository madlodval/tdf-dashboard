---
import ChartCard from "Components/ChartCard.astro";
import Svg from "Components/Svg.astro";

const { main, description } = Astro.locals;
---

<Fragment slot="head">
  <style is:global>
    a[href*="tradingview"] > svg {
      display: none !important;
    }
  </style>
</Fragment>

<Fragment slot="foot">
  <script>import 'Scripts/open-interest.js';</script>
</Fragment>

<div class="flex items-center">
  <h1
    class="flex-1 text-2xl font-extrabold text-gray-900 tracking-tight sm:text-3xl"
  >
    {main.aggregate_stats}
  </h1>
</div>
<p class="mt-6 text-base text-gray-500">
  {description}
</p>
<section class="mt-6 space-y-12 relative">
  <ChartCard class="space-y-6">
    <!-- Barra superior tipo TradingView -->
    <div
      class="bg-white px-4 py-2 flex items-center justify-between border-b border-gray-200"
    >
      <div class="flex items-center gap-3">
        <!-- Dropdown para símbolo -->
        <div
          x-data="{ open: false, symbols: ['BTC', 'ETH', 'XRP', 'BNB', 'SOL'], selected: 'BTC' }"
          class="relative"
          x-cloak  >
          <button
            @click="open = !open"
            class="p-2.5 text-sm font-semibold leading-6 text-gray-900 bg-white rounded-md shadow-none hover:bg-gray-50 focus:outline-none flex items-center"
            type="button"
          >
            <span x-text="selected"></span>
            <svg class="ml-2 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
            </svg>
          </button>
          <div
            x-show="open"
            @click.outside="open = false"
            class="absolute left-0 z-50 mt-2.5 w-40 origin-top-left rounded-md bg-white py-2 shadow-lg ring-1 ring-gray-900/5 focus:outline-none"
          >
            <template x-for="s in symbols" :key="s">
              <button
                @click="selected = s; open = false; $dispatch('symbol-changed', s)"
                class="block w-full text-left px-3 py-1 text-sm leading-6 text-gray-900 hover:bg-gray-50 transition"
              >
                <span x-text="s"></span>
              </button>
            </template>
          </div>
        </div>
        <!-- Dropdown para intervalos (sin label) -->
        <div
          x-data="{ open: false, intervals: ['1d', '4h', '1h'], selected: '1d' }"
          class="relative ml-2"
          x-cloak  >
          <button
            @click="open = !open"
            class="p-2.5 text-sm font-semibold leading-6 text-gray-900 bg-white rounded-md shadow-none hover:bg-gray-50 focus:outline-none flex items-center"
            type="button"
          >
            <span x-text="selected"></span>
            <svg class="ml-2 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
            </svg>
          </button>
          <div
            x-show="open"
            @click.outside="open = false"
            class="absolute left-0 z-50 mt-2.5 w-32 origin-top-left rounded-md bg-white py-2 shadow-lg ring-1 ring-gray-900/5 focus:outline-none"
          >
            <template x-for="i in intervals" :key="i">
              <button
                @click="selected = i; open = false; $dispatch('interval-changed', i)"
                class="block w-full text-left px-3 py-1 text-sm leading-6 text-gray-900 hover:bg-gray-50 transition"
              >
                <span x-text="i"></span>
              </button>
            </template>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <!-- Botones de acciones (incluye fullscreen/reset) -->
        <div class="flex items-center gap-2 ml-4">
          <!-- Fullscreen Icon -->
          <button
            id="fullscreen-btn"
            class="hover:bg-blue-50 p-2 rounded transition"
            title={main.fullscreen as string}
          >
            <Svg src="fullscreen" />
          </button>
          <!-- Camera Icon -->
          <button
            id="screenshot-btn"
            class="hover:bg-blue-50 p-2 rounded transition"
            title={main.download_image as string}
          >
            <Svg src="camera" />
        </button>
          <!-- Botón reset gráficos -->
          <button
            id="reset-charts-btn"
            title={main.reset_charts as string}
            class="p-1 rounded hover:bg-gray-100"
          >
            <!-- Icono de reset estilo TradingView -->
            <Svg src="reset" />
          </button>
        </div>
      </div>
    </div>
    <div class="relative h-full mt-6">
      <div
        id="loading-overlay"
        class="absolute inset-0 flex items-center justify-center bg-white/80 z-50 opacity-0 pointer-events-none transition-opacity duration-500"
      >
        <div class="flex flex-col items-center">
          <div id="loading-spinner" class="flex flex-col items-center">
            <Svg src="loading" />
            <span class="text-blue-700 font-semibold">{main.loading}</span>
          </div>
          <span
            id="loading-error"
            class="hidden text-red-500 font-semibold text-center mt-2"></span>
        </div>
      </div>
      <!-- Precio -->
      <div class="bg-white relative">
        <div class="flex flex-col md:flex-row gap-8">
          <div class="flex-1 overflow-hidden px-4">
            <div class="relative">
              <div
                class="flex justify-between items-center mb-1 relative mt-4"
              >
                <span class="text-sm"> {main.price} </span>
              </div>
              <div id="price-chart" class="min-h-[300px]"></div>
              <div class="border-b border-gray-100 w-full"></div>
            </div>
            <div class="relative">
              <div
                class="flex justify-between items-center mb-1 relative mt-4"
              >
                <span class="text-sm"> {main.open_interest} </span>
              </div>
              <div id="oi-chart" class="min-h-[200px]"></div>
              <div class="border-b border-gray-100 w-full"></div>
            </div>
            <div class="relative">
              <div
                class="flex justify-between items-center mb-1 relative mt-4"
              >
                <span class="text-sm"> {main.volume} </span>
              </div>
              <div id="volume-chart" class="min-h-[200px]"></div>
            </div>
            <div class="relative">
              <div
                class="flex justify-between items-center mb-1 relative mt-4"
              >
                <span class="text-sm"> {main.liquidations} </span>
              </div>
              <div id="liquidation-chart" class="min-h-[200px]"></div>
            </div>
          </div>
        </div>
      </div>
      <div id="charts-resizer" class="border-b border-gray-100 resize hidden">
      </div>
    </div>
  </ChartCard>
</section>

<div id="oi-bar-chart" class="bg-white rounded shadow p-4 mt-6 h-[300px]">
</div>
